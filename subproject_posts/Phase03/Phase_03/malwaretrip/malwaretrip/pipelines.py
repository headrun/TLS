# -*- coding: utf-8 -*-

# Define your item pipelines here
#
# Don't forget to add your pipeline to the ITEM_PIPELINES setting
# See: https://doc.scrapy.org/en/latest/topics/item-pipeline.html

from elasticsearch import Elasticsearch
import hashlib
es = Elasticsearch('http://127.0.0.1:9222')

class MalwaretripPipeline(object):
    def process_item(self, item, spider):
        post_url = item.get('doc',{}).get('post_url','')
        if post_url:
            doc = item.get('doc',{})
            query={"query":{"match":{"_id":hashlib.md5(post_url).hexdigest()}}}
            res = es.search(body=query)
            if res['hits']['hits'] == []:
                es.index(index='malware_posts',doc_type = 'posts',id=hashlib.md5(post_url).hexdigest(),body = doc)
